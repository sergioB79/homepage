<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <title>Sérgio Batalha — Graph</title>
  <style>
    :root{
      /* Theme */
      --bg:#0b1020;         /* from snippet */
      --card:#0f172a;       /* from snippet */
      --text:#e2e8f0;       /* from snippet */
      --muted:#94a3b8;      /* from snippet */
      --accent:#60a5fa;     /* from snippet */
      --border:#1f2a44;     /* from snippet */

      /* App mappings */
      --panel:var(--card);
      --fg:var(--text);
      --owner:#e5e7eb; --cat:#38bdf8; --sub:#93c5fd; --doc:#22c55e; --edge:#7c8591;
      --hot:#f472b6;
    }
    *, *::before, *::after{ box-sizing:border-box }
    html,body{height:100%;}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    header{position:fixed;inset:0 0 auto 0;background:linear-gradient(180deg, rgba(96,165,250,0.08), transparent);
      border-bottom:1px solid var(--border);backdrop-filter:saturate(120%) blur(6px);z-index:10;padding:28px 24px 12px 24px;
      display:flex;gap:6px;align-items:flex-start;flex-direction:column}
    .brand{display:flex;flex-direction:column;gap:2px}
    h1{margin:0;font-size:28px;letter-spacing:.2px;font-weight:700;font-family:'Orbitron','Share Tech Mono',Consolas,'SFMono-Regular',Menlo,monospace}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}
    .meta-time{color:var(--muted);opacity:.85;font-size:11px;margin-top:2px}
    .meta{display:flex;gap:10px;row-gap:8px;font-size:13px;color:var(--muted);margin-top:8px;flex-wrap:wrap}
    .container{max-width:920px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:26px;box-shadow:0 10px 30px rgba(0,0,0,0.25)}
    .card h1, .card h2, .card h3, .card h4{color:#e6f1ff}
    .card a{color:var(--accent);text-decoration:none}
    .card code{background:#0b1220;padding:2px 6px;border-radius:6px}
    .card pre{background:#0b1220;padding:14px;overflow:auto;border-radius:10px;border:1px solid #1d2a45}
    .card table{width:100%;border-collapse:collapse}
    .card table th, .card table td{border:1px solid #1d2a45;padding:8px 10px}
    blockquote{border-left:3px solid var(--accent);padding-left:12px;margin-left:0;color:#cbd5e1}
    hr{border:none;border-top:1px solid var(--border);margin:24px 0}
    .footer{text-align:center;color:var(--muted);font-size:12px;padding:30px 0 60px}
    .badge{background:#0b1220;border:1px solid #1d2a45;padding:2px 8px;border-radius:999px}
    .callout{margin:18px 0 2px;padding:14px 16px;border:1px solid var(--border);border-radius:12px;background:#0b1220}
    .callout h3{margin:0 0 8px 0;font-size:15px;color:#e6f1ff}
    .callout pre{margin-top:8px}
    label.toggle:has(#autorotate){display:none}
    .muted{color:var(--muted)}
    #scene{position:fixed;inset:0;}
    .panel{position:fixed;right:10px;top:92px;z-index:20;background:var(--panel);border:1px solid var(--border);border-radius:14px;
      box-shadow:0 8px 24px rgba(0,0,0,.35);padding:12px 12px;min-width:260px;max-width:360px}
    .panel h3{margin:0 0 8px 0;font-size:13px;letter-spacing:.2px;color:#cdd6e0}
    .row{display:flex;gap:8px;align-items:center;margin:6px 0}
    .row input[type="search"], .row select{flex:1;min-width:120px;background:var(--card);border:1px solid var(--border);color:var(--fg);
      border-radius:10px; padding:8px 10px;}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
    .kpi{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px 10px;text-align:center}
    .kpi b{display:block;font-size:16px}
    .legend{display:block;margin-top:6px}
    .legend-title{font-size:12px;color:#cdd6e0;margin:0 0 6px 0;letter-spacing:.3px}
    .legend-scroll{max-height:220px;overflow:auto;border-top:1px solid var(--border);border-bottom:1px solid var(--border);padding:6px 0}
    .legend-list{list-style:none;margin:0;padding:0}
    .legend-item{display:flex;align-items:center;gap:8px;padding:6px 2px 6px 0;cursor:pointer}
    .legend-item:hover{background:rgba(255,255,255,0.03)}
    .dot{width:11px;height:11px;border-radius:50%}
    .dot.sub{opacity:.85;border:1px solid rgba(0,0,0,.25)}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    button{background:#151b23;color:var(--fg);border:1px solid #243042;border-radius:10px;padding:8px 10px;cursor:pointer}
    button:hover{border-color:#2f3f55}
    label.toggle{display:flex;align-items:center;gap:8px;margin-top:6px;user-select:none}
    input[type="checkbox"]{accent-color:var(--accent)}
    a{color:#8ab4ff;text-decoration:none}
    a:hover{text-decoration:underline}
    footer{position:fixed;left:10px;bottom:10px;color:var(--muted);font-size:12px}
    /* Garantir que elementos com [hidden] ficam invisíveis */
    [hidden]{display:none !important}

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:grid;place-items:center;z-index:20}
    .modal{background:var(--panel);border:1px solid #1a2230;border-radius:14px;box-shadow:0 12px 28px rgba(0,0,0,.45);width:min(680px,calc(100% - 28px));padding:12px 14px}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .modal-header h3{margin:0;font-size:16px;letter-spacing:.2px;color:#cdd6e0}
    #modalClose{background:#151b23;color:var(--fg);border:1px solid #243042;border-radius:10px;padding:4px 8px;cursor:pointer}
    #modalClose:hover{border-color:#2f3f55}
    .modal-body{font-size:14px;color:var(--fg)}
    .modal-body p{margin:6px 0}
    .modal-body ul{margin:6px 0 0 18px}
  </style>
</head>
<body>
  <header>
    <h1>Sérgio Batalha</h1>
    <span class="muted">Rede interativa de categorias, notas e tags</span>
  </header>

  <div id="scene" aria-label="Interactive 3D graph"></div>

  <!-- Modal de informação -->
  <div id="modal" class="modal-overlay" hidden>
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitle"></h3>
        <button id="modalClose" aria-label="Fechar">×</button>
      </div>
      <div id="modalBody" class="modal-body"></div>
    </div>
  </div>

  <aside class="panel">
    <h3>Explorar</h3>
    <div class="row"><input id="q" type="search" placeholder="Pesquisar título ou #tag…" /></div>
    <div class="row">
      <select id="category"><option value="">Todas as categorias</option></select>
    </div>
    <div class="kpis">
      <div class="kpi"><span class="muted">Nós</span><b id="kNodes">0</b></div>
      <div class="kpi"><span class="muted">Arestas</span><b id="kEdges">0</b></div>
      <div class="kpi"><span class="muted">Visíveis</span><b id="kVisible">0</b></div>
    </div>
    <div class="legend" id="legend"></div>
    <label class="toggle"><input id="autorotate" type="checkbox" checked/> Rotação lenta</label>
    <label class="toggle"><input id="sparks" type="checkbox" checked/> Partículas nas arestas por tag</label>
    <div class="btns">
      <button id="fit">Ajustar visão</button>
      <button id="reset">Reset câmara</button>
      <button id="center">Ir para autor</button>
    </div>
    <p class="muted" style="margin-top:8px">Clique num nó de documento para abrir o ficheiro em nova aba.</p>
  </aside>

  <footer>Powered by <a href="https://github.com/vasturiano/3d-force-graph" target="_blank" rel="noreferrer">3d-force-graph</a></footer>

  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/3d-force-graph@1.73.0"></script>
  <script>
  // ---- Estado global
  let Graph, data, ALL_NODES = new Map(), ALL_LINKS = [],
      FILTER = { term:"", category:"" },
      HOVER = { nodeId:null };

  // ---- Data/hora atual (linha pequena no header)
  function updateNow(){
    const header = document.querySelector('header');
    if (!header) return;
    let el = document.getElementById('now');
    if (!el){
      el = document.createElement('div');
      el.id = 'now';
      el.className = 'meta-time';
      header.appendChild(el);
    }
    el.textContent = new Date().toLocaleString('pt-PT', { dateStyle:'medium', timeStyle:'short' });
  }
  updateNow();
  setInterval(updateNow, 30000);

  // Remove o toggle de rotação lenta, se existir
  (function(){
    const a = document.getElementById('autorotate');
    if (a && a.closest('label')) a.closest('label').remove();
  })();

  // ---- Utilidades
  const isTagEdge = l => (l.kind||"").startsWith('tag:');
  const byId = id => ALL_NODES.get(id);
  const idOf = v => (typeof v === 'object' && v) ? v.id : v;
  const css = () => getComputedStyle(document.documentElement);
  function hexToRgba(hex, a){
    const m = (hex||'').trim().replace('#','');
    if (m.length === 3){
      const r = parseInt(m[0]+m[0],16), g=parseInt(m[1]+m[1],16), b=parseInt(m[2]+m[2],16);
      return `rgba(${r}, ${g}, ${b}, ${a})`;
    }
    if (m.length >= 6){
      const r = parseInt(m.slice(0,2),16), g=parseInt(m.slice(2,4),16), b=parseInt(m.slice(4,6),16);
      return `rgba(${r}, ${g}, ${b}, ${a})`;
    }
    return `rgba(96,165,250, ${a})`;
  }

  // ---- Paleta por categoria (tech vibe)
  const CATEGORY_COLORS = {
    trading:       '#22d3ee', // cyan
    apostas:       '#34d399', // emerald
    poker:         '#f59e0b', // amber
    'data-automacao': '#a78bfa', // violet
    ia:            '#fb7185', // rose
    escrita:       '#f472b6', // pink
    arte:          '#60a5fa', // blue
    musica:        '#c084fc', // violet light
    dev:           '#38bdf8', // sky
    projetos:      '#f43f5e', // red
    vida:          '#10b981', // green
    maker:         '#f97316', // orange
    microgreens:   '#84cc16', // lime
    sobre:         '#94a3b8', // slate
    arquivo:       '#64748b'  // slate darker
  };

  function hexToRgb(hex){
    const m = (hex||'').replace('#','');
    const h = m.length===3 ? m.split('').map(c=>c+c).join('') : m.slice(0,6);
    const r = parseInt(h.slice(0,2),16), g = parseInt(h.slice(2,4),16), b = parseInt(h.slice(4,6),16);
    return {r,g,b};
  }
  function rgbToHex({r,g,b}){
    const to = v => Math.max(0,Math.min(255,Math.round(v))).toString(16).padStart(2,'0');
    return `#${to(r)}${to(g)}${to(b)}`;
  }
  // lighten base towards white by factor [0..1]
  function lighten(hex, factor){
    const {r,g,b} = hexToRgb(hex);
    return rgbToHex({ r: r + (255 - r)*factor, g: g + (255 - g)*factor, b: b + (255 - b)*factor });
  }
  function hash01(str){
    let h=0; for(let i=0;i<str.length;i++){ h = (h*31 + str.charCodeAt(i))>>>0; }
    return (h % 1000)/1000; // 0..1
  }

  // ---- Audio (tech beep on clicks)
  const AUDIO = { ctx: null, unlocked: false };
  function ensureAudio(){
    if (!AUDIO.ctx){
      try { AUDIO.ctx = new (window.AudioContext||window.webkitAudioContext)(); }
      catch(_) { AUDIO.ctx = null; }
    }
    if (AUDIO.ctx && AUDIO.ctx.state === 'suspended') AUDIO.ctx.resume();
    AUDIO.unlocked = !!AUDIO.ctx;
  }
  function beep(freq=880, duration=0.08, type='square', gain=0.03){
    if (!AUDIO.ctx) return;
    const ctx = AUDIO.ctx;
    const osc = ctx.createOscillator();
    const g = ctx.createGain();
    osc.type = type; osc.frequency.value = freq;
    g.gain.value = gain;
    osc.connect(g); g.connect(ctx.destination);
    const now = ctx.currentTime;
    osc.start(now);
    // quick decay
    g.gain.setValueAtTime(gain, now);
    g.gain.exponentialRampToValueAtTime(0.0001, now + duration);
    osc.stop(now + duration + 0.01);
  }

  // ---- Modal helpers
  function showModal(title, html){
    const overlay = document.getElementById('modal');
    const t = document.getElementById('modalTitle');
    const b = document.getElementById('modalBody');
    t.textContent = title;
    b.innerHTML = html;
    overlay.hidden = false;
  }
  function hideModal(){
    const overlay = document.getElementById('modal');
    overlay.hidden = true;
  }
  addEventListener('keydown', e=>{ if (e.key==='Escape') hideModal(); });
  // Click fora fecha; botão X fecha
  const __modalOverlay = document.getElementById('modal');
  const __modalClose = document.getElementById('modalClose');
  if (__modalOverlay){
    __modalOverlay.addEventListener('click', e=>{ if (e.target === __modalOverlay) hideModal(); });
  }
  if (__modalClose){ __modalClose.addEventListener('click', hideModal); }

  function openOwnerModal(n){
    const bio = n.bio || 'Autor do grafo.';
    const c = n.contacts || {};
    const lines = [];
    if (c.email) lines.push(`<li>Email: <a href="mailto:${c.email}">${c.email}</a></li>`);
    if (c.github) lines.push(`<li>GitHub: <a href="${c.github}" target="_blank" rel="noreferrer">${c.github}</a></li>`);
    if (c.site) lines.push(`<li>Site: <a href="${c.site}" target="_blank" rel="noreferrer">${c.site}</a></li>`);
    const html = `
      <p>${bio}</p>
      ${lines.length ? `<ul>${lines.join('')}</ul>` : ''}
    `;
    showModal(n.label, html);
  }

  function openCategoryModal(n){
    const key = n.slug || (n.label||'').toLowerCase();
    const docs = (data?.nodes||[]).filter(d=>d.kind==='doc' && d.category===key);
    const subs = (data?.nodes||[]).filter(d=>d.kind==='subcategory' && d.category===key);
    const tagsMap = new Map();
    docs.forEach(d=> (d.tags||[]).forEach(t=> tagsMap.set(t, (tagsMap.get(t)||0)+1)) );
    const tags = [...tagsMap.entries()].sort((a,b)=> b[1]-a[1]).map(([t,c])=>`<li>#${t} <span class="muted">(${c})</span></li>`).join('');
    const about = n.about || `Notas na categoria ${n.label}.`;
    const html = `
      <p class="muted">Categoria</p>
      <p>${about}</p>
      <p><b>${docs.length}</b> documento(s) nesta categoria.</p>
      ${subs.length? `<p class="muted">Subcategorias</p><ul>${subs.map(s=>`<li>${s.label}</li>`).join('')}</ul>` : ''}
      ${tags ? `<p class="muted">Tags usadas</p><ul>${tags}</ul>` : ''}
    `;
    showModal(n.label, html);
  }

  function openSubcategoryModal(n){
    const catSlug = n.category;
    const cat = (data?.nodes||[]).find(x=>x.kind==='category' && (x.slug||'')===catSlug);
    const catName = cat ? cat.label : catSlug;
    const html = `
      <p class="muted">Subcategoria</p>
      <p>${n.about || n.label}</p>
      <p class="muted">Pertence a</p>
      <p><b>${catName}</b></p>
    `;
    showModal(n.label, html);
  }

  // Filtragem: decide visibilidade de nós/arestas
  function computeVisibility(){
    const term = FILTER.term.trim().toLowerCase();
    const cat = FILTER.category;

    // Sem filtros: tudo visível
    if (!term && !cat){
      Graph.nodeVisibility(() => true);
      Graph.linkVisibility(() => true);
      document.getElementById('kVisible').textContent = ALL_NODES.size;
      return;
    }

    // Nós correspondentes (documentos e subcategorias que casam com filtros)
    const match = new Set();
    for (const n of ALL_NODES.values()){
      if (n.kind === 'doc'){
        let ok = true;
        if (cat) ok = (n.category === cat);
        if (ok && term){
          const inLabel = (n.label||'').toLowerCase().includes(term);
          const inTags = Array.isArray(n.tags) && n.tags.some(t=>t.toLowerCase().includes(term));
          ok = inLabel || inTags;
        }
        if (ok) match.add(n.id);
      } else if (n.kind === 'subcategory'){
        let ok = true;
        if (cat) ok = (n.category === cat);
        if (ok && term){ ok = (n.label||'').toLowerCase().includes(term); }
        if (ok) match.add(n.id);
      }
    }

    // Visíveis: nós casados + vizinhos imediatos + contexto
    const visible = new Set();
    for (const l of ALL_LINKS){
      const s = l.source, t = l.target;
      if (match.has(s) || match.has(t)){
        visible.add(s); visible.add(t);
      }
    }
    // Se categoria selecionada, garantir nó da categoria e subcategorias visíveis
    if (cat){
      const catId = 'cat:' + cat;
      visible.add(catId);
      for (const n of ALL_NODES.values()){
        if (n.kind==='subcategory' && n.category===cat) visible.add(n.id);
      }
    }
    if (visible.size === 0){
      for (const n of ALL_NODES.values()) if (n.kind !== 'doc') visible.add(n.id);
    }

    Graph.nodeVisibility(n => visible.has(n.id));
    Graph.linkVisibility(l => {
      const s = (typeof l.source === 'object' && l.source) ? l.source.id : l.source;
      const t = (typeof l.target === 'object' && l.target) ? l.target.id : l.target;
      return visible.has(s) && visible.has(t);
    });

    document.getElementById('kVisible').textContent = visible.size;
  }

  // Destaque hover
  function applyHighlight(){
    const id = HOVER.nodeId;
    const neigh = new Set();
    if (id){
      ALL_LINKS.forEach(l=>{ if (l.source===id) neigh.add(l.target); if (l.target===id) neigh.add(l.source); });
    }
    Graph.linkWidth(l => {
      const s = idOf(l.source), t = idOf(l.target);
      return (id && (s===id || t===id)) ? 3.2 : 1.6;
    });
    Graph.linkColor(l => {
      const s = idOf(l.source), t = idOf(l.target);
      const accent = css().getPropertyValue('--accent').trim() || '#60a5fa';
      const edgeBase = css().getPropertyValue('--edge').trim() || '#7c8591';
      const hotA = 0.95, baseA = isTagEdge(l) ? 0.75 : 0.55;
      const alpha = (id && (s===id || t===id)) ? hotA : baseA;
      const base = isTagEdge(l) ? accent : edgeBase;
      return hexToRgba(base, alpha);
    });
    Graph.nodeVal(n => (n.id===id || neigh.has(n.id)) ? 12 : (n.kind==='owner'?12:(n.kind==='category'?8:(n.kind==='subcategory'?6:4))));
  }

  // Cores por tipo
  function colorFor(n){
    const cs = getComputedStyle(document.documentElement);
    if (n.kind==='owner') return cs.getPropertyValue('--owner').trim();
    if (n.kind==='doc') return cs.getPropertyValue('--doc').trim();
    if (n.kind==='category'){
      const slug = (n.slug || (n.label||'').toLowerCase()).trim();
      return CATEGORY_COLORS[slug] || cs.getPropertyValue('--cat').trim();
    }
    if (n.kind==='subcategory'){
      const base = CATEGORY_COLORS[n.category] || cs.getPropertyValue('--cat').trim() || '#38bdf8';
      // tone per sub using hash: between +15% and +45% lighten
      const t = 0.15 + 0.30 * hash01(n.id || n.label || '')
      return lighten(base, t);
    }
    return cs.getPropertyValue('--doc').trim();
  }

  // Inicialização
  fetch(`graph.json?ts=${Date.now()}`, { cache: 'no-store' })
    .then(r=>{ if(!r.ok) throw new Error('Failed to load graph.json'); return r.json(); })
    .then(async json=>{
    // Tentar ler categoriasNovas.txt e gerar subcategorias
    async function tryAugmentWithCategories(j){
      // If subcategories already exist in graph.json (built), skip augment
      if (Array.isArray(j.nodes) && j.nodes.some(n=>n.kind==='subcategory')) return j;
      try{
        const resp = await fetch('categoriasNovas.txt');
        if (!resp.ok) return j;
        const txt = await resp.text();
        const cats = parseCategoriesText(txt); // [{slug,title,subs[]}]
        const byId = new Map(j.nodes.map(n=>[n.id,n]));
        const existingSlugs = new Set(j.nodes.filter(n=>n.kind==='category').map(n=>n.slug|| (n.label||'').toLowerCase()));
        for (const c of cats){
          const catId = 'cat:' + c.slug;
          let cat = byId.get(catId);
          if (!cat){
            cat = { id: catId, label: c.title || c.slug, slug: c.slug, kind:'category', about: '' };
            j.nodes.push(cat); byId.set(catId, cat);
          }else{
            cat.slug = c.slug; cat.label = c.title || cat.label;
          }
          // subcategorias
          for (const s of (c.subs||[])){
            const subSlug = slugify(s);
            const subId = `sub:${c.slug}:${subSlug}`;
            if (!byId.has(subId)){
              j.nodes.push({ id: subId, label: s.replace(/^"|"$/g,''), kind:'subcategory', category: c.slug, about: s });
              j.links.push({ source: catId, target: subId, kind:'has-sub' });
              byId.set(subId, true);
            }
          }
        }
      }catch(_e){ /* ignora */ }
      return j;
    }

    function slugify(s){
      return (s||'').toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
    }

    function parseCategoriesText(t){
      const lines = t.split(/\r?\n/);
      const out = []; let inCats=false; let current=null; let inSub=false;
      function pushCurrent(){ if (current){ out.push({ slug:current.slug, title:current.title, subs:(current.subs||[]) }); } current=null; inSub=false; }
      for (let raw of lines){
        const line = raw.trim();
        if (!inCats){ if (line.toLowerCase().startsWith('categories:')) { inCats=true; } continue; }
        if (!line) { inSub=false; continue; }
        const mSlug = line.match(/^[-]\s*slug:\s*([^\s]+)/i) || raw.match(/^\s*[-]\s*slug:\s*([^\s]+)/i);
        if (mSlug){ pushCurrent(); current = { slug: (mSlug[1]||'').trim(), title:'', subs:[] }; continue; }
        const mTitle = line.match(/^title:\s*"?(.+?)"?$/i);
        if (mTitle && current){ current.title = mTitle[1]; continue; }
        if (/^sub:\s*$/i.test(line)) { inSub = true; continue; }
        if (inSub){
          const mItem = raw.match(/^\s*[-]\s*"?(.+?)"?\s*$/);
          if (mItem && current){ current.subs.push(mItem[1]); continue; }
        }
        if (line.startsWith('tags:')) { pushCurrent(); break; }
      }
      pushCurrent();
      return out;
    }

    data = await tryAugmentWithCategories(json);
    // Index após augments
    data.nodes.forEach(n=>ALL_NODES.set(n.id, n));
    ALL_LINKS = data.links.map(l=>({
      source: typeof l.source === 'object' ? l.source.id : l.source,
      target: typeof l.target === 'object' ? l.target.id : l.target,
      kind: l.kind
    }));

    // KPIs
    document.getElementById('kNodes').textContent = data.nodes.length;
    document.getElementById('kEdges').textContent = data.links.length;
    console.log(`Loaded graph: nodes=${data.nodes.length}, links=${data.links.length}`);

    // Popular categorias (usar slug quando existir)
    const catSel = document.getElementById('category');
    const categories = data.nodes
      .filter(n=>n.kind==='category')
      .map(n=>({ label: n.label, slug: n.slug || (n.label||'').toLowerCase() }))
      .sort((a,b)=> a.label.localeCompare(b.label, 'pt-PT'));
    for (const c of categories){
      const opt = document.createElement('option');
      opt.value = c.slug; opt.textContent = c.label; catSel.appendChild(opt);
    }

    // Legenda dinâmica
    function buildLegend(){
      const legend = document.getElementById('legend');
      legend.textContent = '';
      // Title
      const title = document.createElement('div'); title.className='legend-title'; title.textContent = 'Categorias'; legend.appendChild(title);
      const scroll = document.createElement('div'); scroll.className='legend-scroll'; legend.appendChild(scroll);
      const ul = document.createElement('ul'); ul.className='legend-list'; scroll.appendChild(ul);

      // Owner & Documento quick chips
      const topRow = document.createElement('div'); topRow.style.display='flex'; topRow.style.gap='10px'; topRow.style.margin='0 0 6px 0'; legend.appendChild(topRow);
      const quick = (color,label)=>{
        const item = document.createElement('span'); item.className='legend-item'; item.style.padding='4px 6px'; item.style.cursor='default';
        const dot = document.createElement('span'); dot.className='dot'; dot.style.background = color; item.appendChild(dot);
        const txt = document.createElement('span'); txt.className='muted'; txt.textContent = label; item.appendChild(txt);
        topRow.appendChild(item);
      };
      quick(css().getPropertyValue('--owner').trim(), 'Autor');
      quick(css().getPropertyValue('--doc').trim(), 'Documento');

      // Categories list
      const cats = data.nodes.filter(n=>n.kind==='category').map(n=>({ slug:n.slug||(n.label||'').toLowerCase(), label:n.label }));
      cats.sort((a,b)=> a.label.localeCompare(b.label,'pt-PT'));
      for (const c of cats){
        const base = CATEGORY_COLORS[c.slug] || css().getPropertyValue('--cat').trim() || '#38bdf8';
        const li = document.createElement('li'); li.className='legend-item'; li.dataset.slug=c.slug;
        const dot = document.createElement('span'); dot.className='dot'; dot.style.background = base; li.appendChild(dot);
        const name = document.createElement('span'); name.textContent = c.label; li.appendChild(name);
        const subDot = document.createElement('span'); subDot.className='dot sub'; subDot.style.background = lighten(base,.3); li.appendChild(subDot);
        const subLbl = document.createElement('span'); subLbl.className='muted'; subLbl.textContent='sub'; li.appendChild(subLbl);
        li.addEventListener('click', ()=>{
          // click selects category filter
          catSel.value = c.slug; FILTER.category = c.slug; computeVisibility();
        });
        ul.appendChild(li);
      }
    }

    // Montar grafo
    Graph = ForceGraph3D()(document.getElementById('scene'))
      .graphData({
        nodes: data.nodes.map(n=>({ ...n })),
        links: ALL_LINKS.map(l=>({ ...l }))
      })
      .backgroundColor(getComputedStyle(document.documentElement).getPropertyValue('--bg').trim())
      .nodeThreeObject(n=>{
        const color = colorFor(n);
        let geo;
        if (n.kind==='owner'){
          geo = new THREE.SphereGeometry(7, 16, 16);
        } else if (n.kind==='doc'){
          geo = new THREE.SphereGeometry(2.6, 12, 12);
        } else if (n.kind==='subcategory'){
          // smaller, same family shape as category (icosahedron for visual coherence)
          geo = new THREE.IcosahedronGeometry(2.8, 0);
        } else if (n.kind==='category'){
          // map some categories to distinctive shapes; fallback to box
          const slug = (n.slug||'').toLowerCase();
          if (slug==='dev') geo = new THREE.BoxGeometry(5,5,5);
          else if (slug==='arte') geo = new THREE.IcosahedronGeometry(4.8, 0);
          else if (slug==='ia') geo = new THREE.OctahedronGeometry(5, 0);
          else if (slug==='trading') geo = new THREE.TetrahedronGeometry(5, 0);
          else if (slug==='apostas') geo = new THREE.ConeGeometry(3.6, 6, 10);
          else if (slug==='poker') geo = new THREE.DodecahedronGeometry(4.8, 0);
          else if (slug==='data-automacao') geo = new THREE.CylinderGeometry(3.2, 3.2, 5.2, 12);
          else if (slug==='maker') geo = new THREE.TorusGeometry(3.2, 1.0, 10, 16);
          else if (slug==='microgreens') geo = new THREE.SphereGeometry(4.2, 16, 16);
          else geo = new THREE.BoxGeometry(4.6,4.6,4.6);
        } else {
          geo = new THREE.SphereGeometry(3.2, 12, 12);
        }
        const mat = new THREE.MeshStandardMaterial({ color, metalness:0.15, roughness:0.45 });
        const mesh = new THREE.Mesh(geo, mat);
        mesh.userData.__isNode = true;
        return mesh;
      })
      .nodeLabel(n=>`$${n.label}`.replace('$','') + (n.tags?.length?`\n#${n.tags.join(' #')}`:''))
      .linkColor(l=>{
        const accent = css().getPropertyValue('--accent').trim() || '#60a5fa';
        const edgeBase = css().getPropertyValue('--edge').trim() || '#7c8591';
        const base = isTagEdge(l) ? accent : edgeBase;
        return hexToRgba(base, isTagEdge(l) ? 0.75 : 0.55);
      })
      .linkOpacity(1)
      .linkWidth(1.6)
      .linkDirectionalParticles(l=> {
        const on = document.getElementById('sparks').checked;
        if (!on) return 0;
        return isTagEdge(l) ? 6 : 2; // show some particles on all links when enabled
      })
      .linkDirectionalParticleWidth(2.2)
      .linkDirectionalParticleColor(l=>{
        const accent = css().getPropertyValue('--accent').trim() || '#60a5fa';
        return hexToRgba(accent, 0.95);
      })
      .linkDirectionalParticleSpeed(0.01);

    // Ajuste de força (quebra de encadeamento necessário)
    Graph.d3Force('charge').strength(-85);

    // Handlers (encadeados a partir da instância Graph)
    Graph
      .onNodeClick(n=>{
        ensureAudio(); if (AUDIO.unlocked) beep(920, 0.06, 'square', 0.035);
        if (n.kind==='doc' && n.path){
          window.open('docs/' + n.path, '_blank');
          return;
        }
        if (n.kind==='owner'){
          openOwnerModal(n);
        } else if (n.kind==='category'){
          openCategoryModal(n);
        } else if (n.kind==='subcategory'){
          openSubcategoryModal(n);
        }
        // Focar a câmara suavemente
        const dist = 80; const {x=0,y=0,z=0} = n; Graph.cameraPosition({ x:x+dist, y:y+dist, z:z+dist }, { x, y, z }, 1200);
      })
      .onNodeHover(n=>{ HOVER.nodeId = n ? n.id : null; applyHighlight(); })
      .onLinkHover(() => {});

    // Iluminação padrão do 3d-force-graph é suficiente

    // Controles sem rotação automática
    const controls = Graph.controls();

    // Filtros
    document.getElementById('q').addEventListener('input', e=>{ FILTER.term = e.target.value; computeVisibility(); });
    document.getElementById('category').addEventListener('change', e=>{
      FILTER.category = (e.target.value||''); computeVisibility();
    });
    document.getElementById('sparks').addEventListener('change', e=>{
      const on = e.target.checked;
      Graph.linkDirectionalParticles(l=> on ? (isTagEdge(l) ? 6 : 2) : 0);
    });

    // Botões
    document.getElementById('fit').addEventListener('click', ()=> Graph.zoomToFit(900));
    document.getElementById('reset').addEventListener('click', ()=>{
      const cam = Graph.camera(); cam.position.set(120,120,120); controls.target.set(0,0,0);
    });
    document.getElementById('center').addEventListener('click', ()=>{
      const owner = data.nodes.find(n=>n.kind==='owner'); if (!owner) return;
      const {x=0,y=0,z=0} = owner; Graph.cameraPosition({ x:x+100,y:y+100,z:z+100 }, {x,y,z}, 1000);
    });

    // Iluminação básica para shapes 3D
    const scene = Graph.scene();
    const dir = new THREE.DirectionalLight(0xffffff, .85); dir.position.set(80,120,40); scene.add(dir);
    scene.add(new THREE.AmbientLight(0xffffff, .35));

    // Visibilidade inicial
    computeVisibility();
    buildLegend();

    // Resize
    addEventListener('resize', ()=> Graph.width(innerWidth).height(innerHeight));
  })
  .catch(err=>{
    console.error('Error loading graph.json:', err);
    const kN = document.getElementById('kNodes');
    const kE = document.getElementById('kEdges');
    if(kN) kN.textContent = '—';
    if(kE) kE.textContent = '—';
  });
  </script>
</body>
</html>
